<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zmiana hasła</title>
</head>
<body>
    <h1>Zmień swoje hasło:</h1>
    <form>
        <label for="newPassword">Nowe hasło:</label>
        <input type="password" id="newPassword" name="newPassword" required><br><br>

        <label for="confirmNewPassword">Potwierdź nowe hasło:</label>
        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required><br><br>

        <button type="submit">Zmień hasło</button>
    </form>
</body>
<script>
    function getCsrfToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith('XSRF-TOKEN=')) {
          return cookie.substring('XSRF-TOKEN='.length);
        }
      }
      return null;
    }

    let userId = null;

    document.addEventListener("DOMContentLoaded", function() {
      fetch('http://localhost:8888/api/v1/authorized/user', {
        method: 'GET',
        headers: {
          'X-XSRF-TOKEN': getCsrfToken()
        }
      }).then(res => res.json())
        .then(data => {
          userId = data.id;
        }).catch(err => {
        console.error('Błąd podczas pobierania danych użytkownika:', err);
      });
    });

    const form = document.querySelector("form");
    form.addEventListener("submit", function(event) {
      event.preventDefault();
      const newPassword = document.getElementById("newPassword").value;
      const confirmNewPassword = document.getElementById("confirmNewPassword").value;

      if (newPassword !== confirmNewPassword) {
        event.preventDefault();
        alert("Nowe hasła nie są zgodne. Proszę spróbować ponownie.");
      }

        fetch(`/api/v1/authorized/admin/user/changePassword/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-XSRF-TOKEN": getCsrfToken()
            },
            body: JSON.stringify({ password: newPassword })
        }).then(res => res.json())
        .then(data => {
            if (data.error === 200) {
                alert("Hasło zostało zmienione pomyślnie.");
                window.location.href = "/admin/users";
            } else {
                alert("Wystąpił błąd podczas zmiany hasła: " + data.message);
            }
        }).catch(err => {
            console.error('Błąd podczas zmiany hasła:', err);
            alert("Wystąpił błąd podczas zmiany hasła. Proszę spróbować ponownie.");
        });
    })
</script>
</html>