<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Pokój czatu</title>
    <link id="favicon" rel="icon" type="image/svg+xml" href="/img/logo/logo-light.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=League+Spartan:wght@100..900&display=swap');

        .font-league-spartan {
            font-family: 'League Spartan', sans-serif;
        }

        .font-jetbrains-mono {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Dodanie SweetAlert2 -->
    <script src="https://kit.fontawesome.com/0a5e3ca64c.js" crossorigin="anonymous"></script>
    <!-- Dodanie Font Awesome -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> <!-- Dodanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Dodanie Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script> <!-- Dodanie SockJS -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script> <!-- Dodanie STOMP -->
    <script>
        // ===== Ustawienia Tailwind CSS =====
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        dark: {
                            background: "#1E1E1E",
                            backgroundSecondary: "#181818",
                            backgroundTertiary: "#101010",
                            textPrimary: "#E1E1E1",
                            textSecondary: "#AFAFAF",
                            accent: "#12e1b9",
                            border: "#333333",
                            surface: "#1E1E1E",
                            accentDark: "#00B189",
                            success: "#00EE00",
                            error: "#D00000",
                            warning: "#FF9831",
                        },
                        light: {
                            background: "#E1E1E1",
                            backgroundSecondary: "#C1C1C1",
                            backgroundTertiary: "#818181",
                            textPrimary: "#252525",
                            surface: "#F5F5F5",
                            border: "#CCCCCC",
                            textSecondary: "#505050",
                            accent: "#ED1E46",
                            accentDark: "#BD0016",
                            success: "#009688",
                            error: "#b388FF",
                            warning: "#FF6F00",
                        },
                    },
                },
            },
        };
        // ==== Zmienne globalne ====
        var userInfo = null;
        var gameId = null;
        var allNotesForGame = null;
        var noteEditorMode = 'preview';
        var gameInfo = {
            id: null,
            name: null,
            system: null,
            description: null,
        }
        const roomId = window.location.pathname.split("/").pop()
        // ===== DOMContentLoaded =====
        document.addEventListener("DOMContentLoaded", () => {
            getUserInfo();
            initThemeToggle();
            applyTheme(getSavedTheme());
            getGameInfo();
            loadAllNotes();
            setTimeout(() => {
                loadNotes();
            }, 1000);
        });
        // ==== Changing the theme ====
        function initThemeToggle() {
            const wrapper = document.getElementById("theme-toggle-wrapper");
            const toggle = document.getElementById("switch-component");
            if (!toggle) return;

            const updateTheme = () => {
                const theme = toggle.checked ? "dark" : "light";
                applyTheme(theme);
            };

            toggle.addEventListener("change", updateTheme);
            wrapper?.addEventListener("click", () => {
                toggle.checked = !toggle.checked;
                updateTheme();
            });
        }
        function applyTheme(theme) {
            document.body.classList.toggle("dark", theme === "dark");
            localStorage.setItem("theme", theme);
            updateFavicon(theme);

            const toggle = document.getElementById("switch-component");
            if (toggle) {
                toggle.checked = (theme === "dark");
            }
        }
        function updateFavicon(theme) {
            const favicon = document.getElementById("favicon");
            if (favicon) {
                favicon.href = `/img/logo/logo-${theme}.svg`;
            }
        }
        function getSavedTheme() {
            return localStorage.getItem("theme") ||
                (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        }
        // ==== CRF Token ====
        function getCsrfToken() {
            const name = "XSRF-TOKEN=";
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name)) {
                    return decodeURIComponent(cookie.substring(name.length));
                }
            }
            return null;
        }
        // ==== Get User Info ====
        function getUserInfo() {
            fetch('/api/v1/authorized/user', {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                userInfo = data;
            }).catch(error => {
                console.error('Error fetching user info:', error);
            });
        }
        // ==== Get Game ID from URL ====
        function getGameInfo() {
            var roomId = window.location.pathname.split("/").pop();
            fetch(`/api/v1/authorized/gameRoom/gameIdForRoomId/${roomId}`, {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(response => {
                if (!response.ok) throw new Error('Failed to fetch gameId');
                return response.json();
            }).then(data1 => {
                gameInfo.id = data1.gameId;

                return fetch(`/api/v1/authorized/game/userGames`, {
                    method: 'GET',
                    headers: {
                        'X-XSRF-TOKEN': getCsrfToken()
                    }
                });
            }).then(response => {
                if (!response.ok) throw new Error('Failed to fetch userGames');
                return response.json();
            }).then(data2 => {
                var game = data2.userGames.find(game => game.id == gameInfo.id);
                if (game) {
                    gameInfo.name = game.name;
                    gameInfo.description = game.description;
                    gameInfo.system = game.rpgSystemId;
                }

                return fetch(`/api/v1/authorized/rpgSystems/${gameInfo.system}`, {
                    method: 'GET',
                    headers: {
                        'X-XSRF-TOKEN': getCsrfToken()
                    }
                });
            }).then(response => {
                if (!response.ok) throw new Error('Failed to fetch rpgSystem');
                return response.json();
            }).then(data3 => {
                gameInfo.system = data3.rpgSystem.name;

                console.log("Final gameInfo:", gameInfo);
            }).catch(error => {
                console.error('Error fetching game info:', error);
            });
        }
        // ==== Note Functions ====
        function loadAllNotes() {
            fetch('/api/v1/authorized/gameNotes', {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                if (data.error !== "200") {
                    console.error('API Error:', data.error);
                }
                noteContent = data.gameNotes;
            }).catch(error => {
                console.error('Nie udało się załadować notatek:', error);
            });
        }
        function loadNotes() {
            fetch(`/api/v1/authorized/gameNotes/game/${gameInfo.id}`, {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                allNotesForGame = data.gameNotes;
                noteContent = [...allNotesForGame];
                const notesContent = document.getElementById("notes-content");
                notesContent.innerHTML = "";
                if (allNotesForGame.length == 0) {
                    notesContent.innerHTML = generateInfoHTML(
                        `Nie masz jeszcze żadnych notatek!`,
                        `Na szczęśnie masz już odblokowaną umiejętność pisania`,
                        `Utwórz swoją pierwszą notatkę już teraz.`
                    );
                } else {
                    allNotesForGame.forEach(note => {
                        notesContent.innerHTML += generatePieceOfNoteHTML(note);
                    });
                }
            }).catch(error => {
                console.error('Error fetching notes:', error);
            });
        }
        function displayNote(idNote) {
            noteEditorMode = 'preview';
            const note = noteContent.find(note => note.id == idNote);
            console.log(note);
            const noteEditor = document.getElementById('note-editor');
            noteEditor.innerHTML = '';
            noteEditor.innerHTML = generateNoteHTML(note);
            actualNote = note;
            showNoteEditor();
        }
        function createNote() {
            noteEditorMode = 'create';
            const noteEditor = document.getElementById('note-editor');
            noteEditor.innerHTML = '';
            noteEditor.innerHTML = generateNewNoteHTML();
            showNoteEditor();
        }
        function deleteNote(idNote) {
            Swal.fire({
                title: 'Czy na pewno chcesz usunąć tę notatkę?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Tak, usuń!',
                cancelButtonText: 'Anuluj'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/v1/authorized/gameNotes/delete/${idNote}`, {
                        method: 'DELETE',
                        headers: {
                            'X-XSRF-TOKEN': getCsrfToken()
                        }
                    }).then(
                        response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        }
                    ).then(data => {
                        if (data.error != "200") {
                            console.error('API Error:', data.error);
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: 'Notatka została usunięta!',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            noteContent = noteContent.filter(note => note.id !== idNote);
                            loadNotes();
                            hideNoteEditor();
                        }
                    }).catch(error => {
                        console.error('Nie udało się usunąć notatki:', error);
                    });
                }
            });
        }
        function saveNote(idNote) {
            getLisinerParesr();
            const noteTitle = document.getElementById('note-title').value.trim();
            const noteText = document.getElementById('note-content').value.trim();
            const gameId = gameInfo.id;
            noteContent.forEach(note => {
                if (note.title == noteTitle && note.id != idNote) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Tytuł już istnieje!',
                        text: `Zmień tytuł notatki, aby zapisać obecną.`,
                    });
                    return;
                }
            })
            var data = [
                { objekt: noteTitle, name: 'Brak tytułu!' },
                { objekt: noteText, name: 'Brak treści!' }
            ]
            data.forEach(element => {
                if (element.objekt == null || element.objekt == undefined || element.objekt == '') {
                    Swal.fire({
                        icon: 'warning',
                        title: `${element.name}`,
                        text: `Uzupełnij wszystkie pola. `,
                    });
                    return;
                }
            });
            if (!gameId || gameId == null || gameId == undefined || gameId == '') {
                return;
            }
            const note = {
                title: noteTitle,
                content: noteText,
                gameId: gameId,
                userId: userInfo.id
            };
            fetch('/api/v1/authorized/gameNotes/add', {
                method: 'POST',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(note)
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                if (data.error != "200") {
                    console.error('API Error:', data.error);
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Notatka została zapisana!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    loadNotes();
                    hideNoteEditor();
                    document.getElementById('search-input').disabled = false;
                    disableControlNoteControls(false);
                    setTimeout(() => {
                        forceReload();
                    }, 1000);
                }
            }).catch(error => {
                console.error('Nie udało się zapisać notatki:', error);
            });
        }
        function editNote(idNote) {
            noteEditorMode = 'edit';
            const note = noteContent.find(note => note.id == idNote);
            const noteEditor = document.getElementById('note-editor');
            noteEditor.innerHTML = '';
            noteEditor.innerHTML = generateEditNoteHTML(note);
            showNoteEditor();
        }
        function showPreviewNote(mode = '') {
            getLisinerParesr();
            const preview = document.getElementById('note-preview');
            let noteTitleBox, noteContentBox, noteConteiner, button;
            if (mode === "create") {
                noteTitleBox = document.getElementById('note-title');
                noteContentBox = document.getElementById('note-content');
                noteConteiner = document.getElementById('new-note-content');
                button = document.getElementById('create-preview-note');
            } else {
                noteTitleBox = document.getElementById('edit-note-title');
                noteContentBox = document.getElementById('edit-note-content');
                noteConteiner = document.getElementById('edit-note-conteiner');
                button = document.getElementById('edit-preview-note');
            }
            if (!noteTitleBox || !noteContentBox || !preview) {
                console.warn('Brakuje elementów do dynamicznego podglądu.');
                return;
            }
            let title = noteTitleBox.value.trim() || "Notatki bez tytułu?";
            let content = noteContentBox.value.trim() || "<p><em>*Podgląd pusty...*</em></p>";
            preview.innerHTML = `
                <h2 class="text-2xl font-bold font-jetbrains-mono text-light-textPrimary dark:text-dark-textPrimary text-left py-1 pb-[1.3em]">${title}</h2>
                <div class="h-[32vh] overflow-auto font-jetbrains-mono text-left text-sm text-light-textSecondary dark:text-dark-textSecondary whitespace-pre-wrap break-words">
                    ${parseMarkdown(content, true)}
                </div>
            `;
            const show = preview.classList.contains('hidden');
            if (button) {
                if (show) {
                    button.innerText = "Zamknij podgląd";
                } else {
                    button.innerText = "Podgląd";
                }
            }
            if (_isMobile) {
                noteTitleBox.classList.toggle('hidden', show);
                noteContentBox.classList.toggle('hidden', show);
                preview.classList.toggle('hidden', !show);
            } else {
                preview.classList.toggle('hidden', !show);
                preview.classList.toggle('block', show);
                preview.classList.toggle('w-1/2', show);
                noteConteiner.classList.toggle('w-1/2', show);
            }
        }
        function saveEditedNote(noteId) {
            disableLisinerParser();
            const noteTitle = document.getElementById('edit-note-title').value.trim();
            const newnoteContent = document.getElementById('edit-note-content').value.trim();
            const oldNote = noteContent.find(note => note.id == noteId);
            if (noteTitle === '' || newnoteContent === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Nie można zapisać notatki!',
                    text: 'Tytuł i treść notatki nie mogą być puste. Uzupełnij brakujące pola przed zapisaniem.',
                });
                return;
            }
            if (noteContent.some(note => note.title === noteTitle && note.id !== noteId)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Tytuł już istnieje!',
                    text: `Zmień tytuł notatki, aby zapisać obecną.`,
                });
                return;
            }
            const note = {
                gameId: gameInfo.id,
                userId: userInfo.id,
                title: noteTitle,
                content: newnoteContent,
            };
            fetch(`/api/v1/authorized/gameNotes/update/${noteId}`, {
                method: 'PUT',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(note)
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                if (data.error != "200") {
                    console.error('API Error:', data.error);
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Notatka została zaktualizowana!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    noteContent = noteContent.map(note => {
                        if (note.id == noteId) {
                            return {
                                ...note,
                                title: noteTitle,
                                content: newnoteContent,
                                updatedAt: new Date().toISOString()
                            };
                        }
                        return note;
                    });
                    loadNotes();
                    hideNoteEditor();
                    document.getElementById('search-input').disabled = false;
                }
            }).catch(error => {
                console.error('Nie udało się zaktualizować notatki:', error);
            });
        }
        // ==== Funtion Editor Display ====
        function showNoteEditor() {
            const backdrop = document.getElementById('note-editor-backdrop');
            const editor = document.getElementById('note-editor');
            backdrop.classList.remove('pointer-events-none', 'opacity-0');
            backdrop.classList.add('opacity-100');
            editor.classList.remove('scale-95', 'opacity-0');
            editor.classList.add('scale-100', 'opacity-100');
        }
        function hideNoteEditor() {
            const backdrop = document.getElementById('note-editor-backdrop');
            const editor = document.getElementById('note-editor');
            backdrop.classList.add('opacity-0', 'pointer-events-none');
            backdrop.classList.remove('opacity-100');
            editor.classList.add('scale-95', 'opacity-0');
            editor.classList.remove('scale-100', 'opacity-100');
        }
    </script>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <nav
        class="flex justify-around w-full p-6 bg-light-surface dark:bg-dark-surface border-b border-light-border dark:border-dark-border">
        <a href="/home">
            <div class="flex items-center">
                <img id="logo-light" src="/img/logo/logo-light.svg" alt="RPG Manager" class="h-10 w-10 dark:hidden">
                <img id="logo-dark" src="/img/logo/logo-dark.svg" alt="RPG Manager" class="h-10 w-10 hidden dark:block">
                <h1
                    class="text-xl font-semibold ml-3 text-light-textPrimary dark:text-dark-textPrimary font-jetbrains-mono">
                    RPG Handy Helper
                </h1>
            </div>
        </a>
        <div id="theme-toggle-wrapper" class="flex items-center justify-center">
            <i class="fa-solid fa-sun p-2 text-light-accent dark:text-dark-accent"></i>
            <div class="relative inline-block w-12 h-6">
                <input id="switch-component" type="checkbox" class="peer hidden m-1" />
                <label for="switch-component" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full
                       bg-light-accent dark:bg-dark-accent
                       shadow-md transition-all duration-300 
                       peer-checked:translate-x-[0.75rem] 
                       peer-checked:dark:bg-dark-accent peer-checked:bg-light-accent
                       cursor-pointer hover:shadow-lg">
                </label>
                <div class="w-12 h-6 rounded-full transition-all duration-300 cursor-pointer
                        bg-light-backgroundSecondary dark:bg-dark-backgroundTertiary">
                </div>
            </div>
            <i class="fa-solid fa-moon p-2 text-light-accent dark:text-dark-accent"></i>
        </div>
    </nav>
    <main
        class="min-h-[86.75vh] flex-grow flex flex-col items-center justify-center bg-light-background dark:bg-dark-background w-full">
        <div class="flex gap-[2%] flex-row flex-nowrap justify-center items-stretch w-[100vw] min-h-[80vh] p-4">
            <section id="character-card"
                class="flex flex-col items-start justify-start grow w-[32vw] bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg w-full max-w-xl p-4 px-8">
                <a href="#"
                    class="p-4 relative self-end -top-2 -right-6 text-light-textPrimary dark:text-dark-textPrimary z-10">
                    <i class="fa-solid fa-arrow-up-right-from-square text-3xl" aria-hidden="true"></i>
                </a>
                <h1
                    class="font-jetbrains-mono text-3xl mt-[-1.75em] text-light-textPrimary dark:text-dark-textPrimary m-3">
                    Karta Postaci</h1>
                <div id="character-card-info">
                    <h1 class="font-jetbrains-mono text-3xl">#Będzie</h1>
                </div>
            </section>
            <section id="chat-container"
                class="flex flex-col grow w-[32vw] bg-light-surface dark:bg-dark-surface rounded-xl shadow-lg w-full max-w-xl p-4">
                <div class="flex flex-col gap-2">
                    <div id="chat"
                        class="flex flex-col gap-2 bg-white dark:bg-dark-background border border-gray-300 dark:border-dark-border rounded-lg p-4 h-[65vh] overflow-y-auto mb-4 text-sm">
                        <!-- Wiadomości będą dodawane tutaj -->
                    </div>
                    <form id="message-form" class="flex gap-2">
                        <input type="text" id="message-input" placeholder="ja pisze wiadomosc i zara wysle"
                            autocomplete="off" required
                            class="flex-1 px-3 py-2 rounded-full border border-gray-400 text-sm dark:bg-dark-surface dark:text-white font-jetbrains-mono placeholder:text-sm" />
                        <button type="submit"
                            class="px-5 py-2 bg-light-accent text-white font-bold rounded-full hover:bg-light-accentDark transition-colors text-sm">
                            wyślij
                        </button>
                    </form>
                </div>
            </section>
            <section id="notes-container" class="flex flex-col gap-[2%] grow w-[32vw] w-full max-w-xl">
                <div id="notes-container"
                    class="flex flex-col items-start justify-start grow w-[32vw] bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg w-full max-w-xl p-4 px-8 h-[79%]">
                    <a href="#"
                        class="p-4 relative self-end -top-2 -right-6 text-light-textPrimary dark:text-dark-textPrimary z-10">
                        <i class="fa-solid fa-arrow-up-right-from-square text-3xl" aria-hidden="true"></i>
                    </a>
                    <div id="notes-container-info"
                        class="flex flex-col items-start justify-start grow w-[32vw] bg-light-surface dark:bg-dark-surface rounded-lg  w-full max-w-xl">
                        <div id="notes-info"
                            class="flex flex-col items-center justify-center h-[10%] w-full mt-[-1rem]">
                            <button id="add-note"
                                class="text-2xl sm:text-3xl py-4 px-5 sm:px-10 mb-4 bg-light-accent dark:bg-dark-accent text-dark-textPrimary dark:text-dark-textPrimary rounded-lg hover:bg-light-accentDark dark:hover:bg-dark-accentDark transition duration-300 whitespace-nowrap font-bold font-jetbrains-mono disabled:dark:bg-dark-accentDark disabled:cursor-not-allowed disabled:bg-light-accentDark disabled:opacity-50"
                                onclick="createNote()">
                                STWÓRZ NOWĄ NOTATKĘ
                            </button>
                            <div class="sm:w-full flex items-center space-x-2">
                                <label
                                    class="font-semibold text-light-textPrimary dark:text-dark-textPrimary whitespace-nowrap">
                                    Wyszukaj
                                </label>
                                <div class="w-full">
                                    <input type="text" placeholder="Wpisz słowo klucz" id="search-input"
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm text-black dark:text-white bg-white dark:bg-dark-surface placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-0" />
                                </div>
                            </div>

                        </div>
                        <div id="notes-content"
                            class="flex flex-col items-center justify-center w-full h-[90%] p-3 overflow-y-auto">
                            <div class="w-12 h-12 border-4 border-light-accent dark:border-dark-accent rounded-full animate-ping"
                                role="status" aria-label="Ładowanie"></div>
                        </div>
                    </div>

                </div>
                <div id="dice-container"
                    class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg h-[19%] pt-8 p-6 flex-col justify-center items-center gap-1">
                    <div class="controls flex flex-wrap items-center gap-2 mb-4">
                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD4"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d4')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d4')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D4')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    4
                                </p>
                            </div>
                        </div>

                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD6"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d6')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d6')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D6')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    6
                                </p>
                            </div>
                        </div>

                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD8"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d8')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d8')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D8')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    8
                                </p>
                            </div>
                        </div>
                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD10"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d10')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d10')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D10')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    10
                                </p>
                            </div>
                        </div>
                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD12"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d12')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d12')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D12')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    12
                                </p>
                            </div>
                        </div>
                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD20"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d20')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d20')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D20')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    20
                                </p>
                            </div>
                        </div>
                        <div class="relative flex flex-col items-center justify-center w-10 h-10 group">
                            <!-- Popup pojawia się przy hover/focus lub może być na stałe -->
                            <div id="dicePopupD100"
                                class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                                <button onclick="addDice('d100')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    +
                                </button>
                                <button onclick="removeDice('d100')"
                                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                                    −
                                </button>
                            </div>
                            <!-- Ikona kości -->
                            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('D100')">
                                <img src="/img/assets/dice-icon-dark-version.svg"
                                    class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                                <img src="/img/assets/dice-icon-light-version.svg"
                                    class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                                <p
                                    class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                                    100
                                </p>
                            </div>
                        </div>
                        <input type="text" id="dice-input" placeholder="Np. 2d10"
                            class="px-3 py-2 border border-gray-400 rounded-md flex-1 w-full text-light-textPrimary dark:text-dark-textPrimary" />
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="relative w-max">
                            <select id="dice-theme"
                                class="font-jetbrains-mono appearance-none bg-light-surface dark:bg-dark-surface text-light-textPrimary dark:text-dark-textPrimary border border-black dark:border-white px-4 py-2 pr-10 rounded-md shadow-sm">
                            </select>
                            <img src="/img/assets/expand_button_light_version.svg"
                                class="pointer-events-none absolute right-3 z-3 mt-[-2rem] dark:hidden block w-6 h-6"
                                alt="Expand Light" />
                            <img src="/img/assets/expand_button_dark_version.svg"
                                class="pointer-events-none absolute right-3 z-3 mt-[-2rem] dark:block hidden w-6 h-6"
                                alt="Expand Dark" />
                        </div>
                        <div>
                            <button id="rollReset" onclick="resetDice()"
                                class="text-base font-bold font-jetbrains-mono bg-light-accent dark:bg-dark-accent text-white px-4 py-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark transition duration-300 whitespace-nowrap">
                                Reset
                            </button>
                            <button id="rollCustom"
                                class="text-base font-bold font-jetbrains-mono bg-light-accent dark:bg-dark-accent text-white px-4 py-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark transition duration-300 whitespace-nowrap">
                                Rzuć
                            </button>
                        </div>
                    </div>

                    <div id="dice-result" class="text-lg font-medium text-center mb-4"></div>
                    <div id="dice-container" class="fixed top-0 left-0 w-screen h-screen pointer-events-none z-50">
                    </div>
                </div>
        </div>
        </section>
        <!-- Edytor notatki -->
        <div id="note-editor-backdrop"
            class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none bg-black/30 dark:bg-black/50 transition-opacity duration-300">
            <div id="note-editor"
                class="w-[90vw] sm:w-[95vw] md:w-[70vw] lg:w-[50vw] bg-white dark:bg-dark-surface text-black dark:text-white p-6 px-10 rounded-lg shadow-xl overflow-auto flex-col justify-between transition-all duration-300 ease-in-out scale-95 opacity-0">
            </div>
        </div>
    </main>
    <footer
        class="w-full text-center p-4 bg-light-surface dark:bg-dark-surface font-jetbrains-mono text-light-text dark:text-dark-text border-t border-light-border dark:border-dark-border">
        <h3 class="text-light-textPrimary dark:text-dark-textPrimary">Od Graczy dla Graczy © 2025 RPG Handy Helper</h3>
        <a href="https://github.com/xEdziu/RPG-Handy-Helper" target="_blank"
            class="text-light-accent dark:text-dark-accent">
            <i class="fa-brands fa-github"></i>
        </a>
    </footer>
</body>

</html>
<script type="module">
    import DiceBox from "https://cdn.jsdelivr.net/npm/@3d-dice/dice-box@1.1.4/dist/dice-box.es.min.js";
    let username = null;
    let stompClient = null;

    fetch("/api/v1/authorized/user")
        .then(res => res.json())
        .then(data => {
            username = data.username;
            initWebSocket();
        });

    function initWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, () => {
            stompClient.subscribe(`/topic/chat/${roomId}`, msg => {
                const { from, content } = JSON.parse(msg.body);
                appendMessage(from, content);
            });
            stompClient.subscribe(`/topic/dice/${roomId}`, msg => {
                const { from, content } = JSON.parse(msg.body);
                if (from !== username) {
                    const [notation, theme] = content.split("|");
                    rollDice(notation, theme, from);
                }
            });
            stompClient.send(`/app/join/${roomId}`, {}, {});
        });
    }
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }
    function appendMessage(from, content) {
        const chat = document.getElementById("chat");
        const msgWrapper = document.createElement("div");
        const isSystem = from.includes("System") || from === "🧊 System";
        msgWrapper.className = isSystem
            ? "bg-white text-gray-600 italic text-center text-sm px-3 py-2 rounded-md shadow-sm font-jetbrains-mono"
            : "bg-[#f5f6f8] px-4 py-2 rounded-lg shadow-sm font-jetbrains-mono text-sm";
        if (isSystem) {
            msgWrapper.textContent = content;
        } else {
            const usernameDiv = document.createElement("div");
            usernameDiv.className = "text-red-600 font-bold mb-1";
            usernameDiv.textContent = escapeHtml(from);

            const contentDiv = document.createElement("div");
            contentDiv.className = "text-black";
            contentDiv.textContent = escapeHtml(content);

            msgWrapper.appendChild(usernameDiv);
            msgWrapper.appendChild(contentDiv);
        }
        chat.appendChild(msgWrapper);
        chat.scrollTop = chat.scrollHeight;
    }

    document.getElementById("message-form").addEventListener("submit", e => {
        e.preventDefault();
        const input = document.getElementById("message-input");
        const content = input.value.trim();
        if (content && stompClient?.connected) {
            stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({ from: username, content }));
            input.value = "";
        }
    });

    const themes = [
        { id: "default", label: "Domyślny" },
        { id: "gemstoneMarble", label: "Gemstone Rainbow Marble" },
        { id: "blueGreenMetal", label: "Blue Green Metal" }
    ];

    const themeSelect = document.getElementById("dice-theme");
    const savedTheme = localStorage.getItem("selectedDiceTheme") || "default";
    themes.forEach(({ id, label }) => {
        const opt = new Option(label, id, false, id === savedTheme);
        themeSelect.appendChild(opt);
    });
    themeSelect.addEventListener("change", () => {
        localStorage.setItem("selectedDiceTheme", themeSelect.value);
    });

    const diceBox = new DiceBox("#dice-container", {
        assetPath: "/assets/",
        origin: location.origin,
        scale: window.innerWidth < 600 ? 5 : window.innerWidth < 900 ? 6 : window.innerWidth < 1200 ? 7 : 9,
        gravity: 3,
        friction: 0.5,
        strength: 10,
        spinForce: 6,
        throwForce: 6,
        mass: 3
    });

    await diceBox.init();
    await diceBox.loadTheme("default");

    let rolling = false;
    let rollPool = [];

    document.querySelectorAll('[data-roll]').forEach(btn => {
        btn.addEventListener("click", () => addToPool(btn.dataset.roll));
    });

    document.getElementById("rollCustom").addEventListener("click", async () => {
        const input = document.getElementById("dice-input").value.trim().toLowerCase().replace(/k/g, "d").replace(/\s+/g, "");
        if (!/^\d*d(4|6|8|10|12|20|100)(\+\d*d(4|6|8|10|12|20|100))*$/.test(input)) {
            return Swal.fire({ icon: 'error', title: 'Błędna notacja', text: 'Np. 2d6+1d8' });
        }

        const segments = input.split("+").map(seg => {
            const [_, qty = "1", sides] = seg.match(/(\d*)d(\d+)/);
            return { qty: +qty, sides: +sides };
        });

        if (rolling) return;
        rolling = true;
        document.querySelectorAll('button[id^="roll"]').forEach(btn => btn.disabled = true);

        let total = 0, nat = [];
        const theme = themeSelect.value;
        if (!diceBox.themesLoadedData[theme]) await diceBox.loadTheme(theme);

        for (let { qty, sides } of segments) {
            const res = await diceBox.roll(`${qty}d${sides}`, { theme });
            total += res.reduce((sum, die) => sum + die.value, 0);
            res.forEach(d => {
                nat.push(d.sides === 20 && (d.value === 1 || d.value === 20)
                    ? (d.value === 20 ? '🎯 NAT20' : '💀 NAT1')
                    : `d${d.sides}: ${d.value}`);
            });
            await new Promise(r => setTimeout(r, 1500));
            diceBox.clear();
        }

        document.getElementById("dice-result").textContent = `Łączny wynik: ${total}`;
        stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({
            from: "🧊 System",
            content: `${username} wylosował ${total} (${nat.join(", ")})`
        }));

        rollPool = [];
        document.getElementById("dice-input").value = "";
        document.querySelectorAll('button[id^="roll"]').forEach(btn => btn.disabled = false);
        rolling = false;
    });

    function addToPool(notation) {
        notation = notation.toLowerCase().replace(/k/g, "d");
        const match = notation.match(/(\d+)d(\d+)/);
        if (!match) return Swal.fire({ icon: 'error', title: 'Nieprawidłowa notacja', text: notation });

        const [_, qty, sides] = match;
        const existing = rollPool.findIndex(r => r.endsWith(`d${sides}`));
        if (existing !== -1) {
            const m = rollPool[existing].match(/(\d+)d(\d+)/);
            const newQty = +m[1] + +qty;
            if (newQty > 20) return Swal.fire({ icon: 'warning', title: 'Za dużo kości', text: `Już masz ${m[1]}d${sides}` });
            rollPool[existing] = `${newQty}d${sides}`;
        } else {
            rollPool.push(`${qty}d${sides}`);
        }
        document.getElementById("dice-input").value = rollPool.join("+");
    }
</script>
<script>
    // ==== Dice Popup ====
    function showPopup(diceType) {
        setTimeout(() => {
            const dicePopups = document.querySelectorAll('.dicePopup');
            const popupToShow = document.getElementById(`dicePopup${diceType}`);

            dicePopups.forEach(popup => {
                if (popup !== popupToShow) {
                    popup.classList.add('hidden', 'opacity-0');
                    popup.classList.remove('opacity-100');
                }
            });

            if (popupToShow) {
                popupToShow.classList.remove('hidden', 'opacity-0');
                popupToShow.classList.add('opacity-100');
            }
        }, 0);
    }
    // ==== Dice Functions ====
    function addDice(type) {
        const diceInput = document.getElementById("dice-input");
        const value = diceInput.value.toLowerCase().replace(/k/g, "d").replace(/\s+/g, "");
        const regex = new RegExp(`(\\d*)${type}(?!\\d)`);
        const match = value.match(regex);
        let newValue;
        if (match) {
            let qty = parseInt(match[1] || "1");
            qty++;
            newValue = value.replace(regex, `${qty}${type}`);
        } else {
            newValue = value ? `${value}+1${type}` : `1${type}`;
        }
        diceInput.value = newValue;
        updateDiceLabel(type);
    }
    function removeDice(type) {
        const diceInput = document.getElementById("dice-input");
        const value = diceInput.value.toLowerCase().replace(/k/g, "d").replace(/\s+/g, "");
        const regex = new RegExp(`(\\d*)${type}(?!\\d)`);
        const match = value.match(regex);
        if (match) {
            let qty = parseInt(match[1] || "1");
            if (qty <= 1) {
                const updated = value
                    .split("+")
                    .filter(part => !part.includes(type))
                    .join("+");
                diceInput.value = updated;
            } else {
                const newValue = value.replace(regex, `${qty - 1}${type}`);
                diceInput.value = newValue;
            }
        }
        updateDiceLabel(type);
    }
    function updateDiceLabel(type) {
        const diceInput = document.getElementById("dice-input").value.toLowerCase();
        const regex = new RegExp(`(\\d*)${type}(?!\\d)`);
        const match = diceInput.match(regex);
        const count = match ? parseInt(match[1] || "1") : 0;
        const label = document.querySelector(`[data-roll="1${type}"] p`);
        if (label) label.textContent = count > 0 ? count : "0";
    }

    // ==== Listener for Window Size ====
    var _isMobile = false;
    window.addEventListener('resize', function () {
        const windowWidth = window.innerWidth
        if (windowWidth < 1024) {
            _isMobile = true;
        } else {
            _isMobile = false;
        }
    });
    window.addEventListener('load', function () {
        const windowWidth = window.innerWidth
        if (windowWidth < 1024) {
            _isMobile = true;
        } else {
            _isMobile = false;
        }
    });
    // ==== Function to Parse Markdown in Real Time ====
    let _markdownParserListeners = [];
    function getLisinerParesr() {
        const titleInput = document.getElementById('edit-note-title') || document.getElementById('note-title');
        const contentInput = document.getElementById('edit-note-content') || document.getElementById('note-content');
        const preview = document.getElementById('note-preview');
        if (!titleInput || !contentInput || !preview) {
            console.warn('Brakuje elementów do dynamicznego podglądu.');
            return;
        }
        function updatePreviewLive() {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const parsed = parseMarkdown(content || "", true);
            preview.innerHTML = `
            <h2 class="text-2xl font-bold font-jetbrains-mono text-light-textPrimary dark:text-dark-textPrimary text-left py-1 pb-[1.3em]">${title || "Notatki bez tytułu?"}</h2>
            <div class="h-[32vh] overflow-auto font-jetbrains-mono text-left text-sm text-light-textSecondary dark:text-dark-textSecondary whitespace-pre-wrap break-words">
                ${parsed.length > 0 ? parsed : "<p><em>*Podgląd pusty...*</em></p>"}
            </div>
        `;
        }
        titleInput.addEventListener('input', updatePreviewLive);
        contentInput.addEventListener('input', updatePreviewLive);
        _markdownParserListeners = [
            { el: titleInput, fn: updatePreviewLive },
            { el: contentInput, fn: updatePreviewLive }
        ];
        updatePreviewLive();
    }
    function disableLisinerParser() {
        if (!_markdownParserListeners || _markdownParserListeners.length === 0) return;
        _markdownParserListeners.forEach(({ el, fn }) => {
            el.removeEventListener('input', fn);
        });
        _markdownParserListeners = [];
    }
    // ==== Pareser Markdown ====
    function parseMarkdown(markdownText, ifAllNote = false) {
        var parsedParagraph = marked.parse(markdownText);
        if (ifAllNote) {
            parsedParagraph = parsedParagraph.replace(/<p>/g, '<p class="mt-[-3em]">');
        }
        return parsedParagraph;
    }
    // ==== Truncate Text ====
    function truncateText(text, maxLength = Infinity) {
        return text.length > maxLength
            ? text.slice(0, maxLength) + '...'
            : text;
    }
    // ==== Format Date ====
    function formatDate(dateString) {
        return new Date(dateString).toLocaleString("pl-PL", {
            year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"
        });
    }
    // ==== Listener for Note ====
    document.addEventListener('click', (e) => {
        const dicePopups = document.querySelectorAll('.dicePopup');
        const isPopupButton = e.target.closest('[data-popup-trigger]') !== null;
        let clickedInsideAnyPopup = false;
        dicePopups.forEach(popup => {
            if (popup.contains(e.target)) {
                clickedInsideAnyPopup = true;
            }
        });
        if (!clickedInsideAnyPopup && !isPopupButton) {
            dicePopups.forEach(popup => {
                popup.classList.add('hidden', 'opacity-0');
                popup.classList.remove('opacity-100');
            });
        }

        const backdrop = document.getElementById('note-editor-backdrop');
        const editor = document.getElementById('note-editor');
        if (!editor || !backdrop) return;
        const isEditorVisible = !backdrop.classList.contains('pointer-events-none');
        const clickedBackdrop = isEditorVisible && e.target === backdrop;
        if (!clickedBackdrop) return;
        if (noteEditorMode === 'create') {
            const noteTitle = document.getElementById('note-title').value.trim();
            const noteText = document.getElementById('note-content').value.trim();
            if (noteTitle === '' && noteText === '') {
                noteEditorMode = 'preview';
                hideNoteEditor();
                return;
            }
        }
        if (noteEditorMode === 'edit') {
            const noteTitle = document.getElementById('edit-note-title').value.trim();
            const noteText = document.getElementById('edit-note-content').value.trim();
            if (noteTitle === actualNote.title && noteText === actualNote.content) {
                noteEditorMode = 'preview';
                hideNoteEditor();
                return;
            }
        }
        if (noteEditorMode === 'edit' || noteEditorMode === 'create') {
            Swal.fire({
                title: 'Czy na pewno chcesz wyjść?',
                text: 'Niezapisane zmiany zostaną utracone!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Tak, wyjdź',
                cancelButtonText: 'Nie, wróć'
            }).then((result) => {
                if (result.isConfirmed) {
                    noteEditorMode = 'preview';
                    hideNoteEditor();
                }
            });
        } else {
            noteEditorMode = 'preview';
            hideNoteEditor();
        }
    });
    // ==== Variable for Styling ====
    var noteStyle = "w-[100%] max-w-2xl p-4 border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface rounded-lg m-2 cursor-pointer bg-light-surface dark:bg-dark-surface transition duration-300 text-light-textPrimary dark:text-dark-textPrimary hover:bg-light-backgroundTertiary dark:hover:bg-dark-backgroundTertiary break-words whitespace-normal overflow-hidden text-ellipsis";
    var infoStyle = "w-[100%] max-w-2xl p-4 border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface rounded-lg m-2 cursor-pointer bg-light-surface dark:bg-dark-surface transition duration-300 text-light-textPrimary dark:text-dark-textPrimary font-jetbrains-mono";
    // ==== Function to generate html ====
    function generateInfoHTML(info1, info2, info3) {
        return `
            <div class="${infoStyle}">
                ${info1 ? `<p class="text-light-textPrimary dark:text-dark-textPrimary m-2">${info1}</p>` : ''}
                ${info2 ? `<p class="text-light-textPrimary dark:text-dark-textPrimary m-2">${info2}</p>` : ''}
                ${info3 ? `<p class="text-light-textPrimary dark:text-dark-textPrimary m-2">${info3}</p>` : ''}
            </div>
        `;
    }
    function generatePieceOfNoteHTML(note) {
        return `
        <div class="${noteStyle}" onclick="displayNote(${note.id})">
            <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col sm:flex-row text-xl font-semibold mb-1 font-jetbrains-mono gap-x-4">
                    <span class="text-light-accent dark:text-dark-accent"> ${note.gameName}</span>
                    ${note.rpgSystemName}
                </div>
                <small class="hidden sm:block">${formatDate(note.updatedAt)}</small>
            </div>
            <h2 class= "text-2xl font-semibold mb-2 font-jetbrains-mono">${note.title}</h2>
            <p class="ml-8 break-words whitespace-normal overflow-hidden text-ellipsis">${parseMarkdown(truncateText(note.content, 80))}</p>
        </div>
        `;
    }
    function generateNewNoteHTML() {
        return `
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col items-start w-1/2">
                <p id="game-system" class="text-base font-bold text-light-textPrimary dark:text-dark-textPrimary mb-1">${gameInfo.system}</p>
                <p id="game-name" class="text-base font-bold text-light-accent dark:text-dark-accent mb-1">${gameInfo.name}</p>
                <p id="game-description-new-note" class="text-xs font-bold text-light-textPrimary dark:text-dark-textPrimary">${gameInfo.description}</p>
            </div>
            <div class="flex flex-col lg:flex-row gap-2 items-right">
                <button id="save-note"
                    class="text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark"
                    onclick="saveNote()">Zapisz</button>
                <button id="create-preview-note"
                    class="text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark"
                    onclick="showPreviewNote('create')">Podgląd</button>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-4 min-h-[43vh]">
            <div class="flex flex-col w-full" id="new-note-content">
                <input id="note-title" type="text" placeholder="Tytuł notatki" maxlength="90"
                    class="my-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-lg text-black dark:text-white bg-white dark:bg-dark-surface placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-0 font-jetbrains-mono">
                <textarea id="note-content" rows="10" placeholder="Treść notatki"
                    class="h-[32vh] my-1 w-full p-4 border border-gray-300 dark:border-gray-600 rounded resize-none text-sm text-black dark:text-white bg-white dark:bg-dark-surface focus:outline-none focus:ring-0 overflow-auto font-jetbrains-mono"></textarea>
            </div>
            <div id="note-preview"
                class="w-full lg:w-1/2 px-2 p-2 rounded prose dark:prose-invert bg-white dark:bg-dark-surface hitespace-pre-wrap break-words text-left hidden">

            </div>
        </div>
        `;
    }
    function generateNoteHTML(note) {
        return `
        <div class="flex flex-col sm:flex-row justify-end lg:flex-row gap-2 sm:gap-4 mb-4 sm:mb-0">
            <div class="flex flex-col w-full">
                <p class="text-base font-bold text-light-textPrimary dark:text-dark-textPrimary mb-1">${note.rpgSystemName}</p>
                <p class="text-base font-bold text-light-accent dark:text-dark-accent mb-1">${note.gameName}</p>
                <p id="game-description-new-note" class="text-xs font-bold text-light-textPrimary dark:text-dark-textPrimary">${gameInfo.description}</p>
            </div>
            <div class="flex flex-col items-start justify-start text-xs text-light-textSecondary dark:text-dark-textSecondary whitespace-nowrap">
                <p>Ostatnia modyfikacja: ${formatDate(note.updatedAt)}</p>
                <p>Utworzono: ${formatDate(note.createdAt)}</p>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-4 min-h-[43vh]">
            <div class="flex flex-col w-full">
                <div class="w-full mb-4 flex justify-between items-start gap-2">
                  <h1 class="mt-2 text-2xl font-bold font-jetbrains-mono text-light-textPrimary dark:text-dark-textPrimary leading-tight break-words whitespace-normal w-[70%]">
                    ${note.title}
                  </h1>
                  <div class="flex-shrink-0 flex gap-2 xl:flex-row align-end flex-col md:flex-row">
                    <button onclick="editNote(${note.id})"
                      class="w-fit text-base font-bold bg-light-accent dark:bg-dark-accent text-white px-4 py-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark whitespace-nowrap">
                      Edytuj
                    </button>
                    <button onclick="deleteNote(${note.id})"
                      class="w-[80px] text-base font-bold bg-light-error dark:bg-dark-error text-white px-4 py-2 rounded hover:bg-red-600 whitespace-nowrap">
                      Usuń
                    </button>
                  </div>
                </div>
                <div class="h-[32vh] overflow-auto font-jetbrains-mono text-left text-sm text-light-textSecondary dark:text-dark-textSecondary whitespace-pre-wrap break-words">
                    ${parseMarkdown(note.content, true)}
                </div>
            </div>
        </div>
        `;
    }
    function generateEditNoteHTML(note) {
        return `
        <div class="flex flex-row justify-end lg:flex-row gap-4">
            <div class="flex flex-col w-full">
                <p id="game-system" class="text-base font-bold text-light-textPrimary dark:text-dark-textPrimary mb-1">${note.rpgSystemName}</p>
                <p id="game-name" class="text-base font-bold text-light-accent dark:text-dark-accent mb-1">${note.gameName}</p>
                <p id="game-description-new-note" class="text-xs font-bold text-light-textPrimary dark:text-dark-textPrimary">${gameInfo.description}</p>
            </div>
            <div class="flex gap-2 items-centerv flex-col md:flex-ro">
                <button id="edit-preview-note"
                    class="w-fit text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark whitespace-nowrap"
                    onclick="showPreviewNote('edit')">Podgląd</button>
                <button id="save-note"
                    class="text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark whitespace-nowrap"
                    onclick="saveEditedNote(${note.id})">Zapisz</button>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-4 min-h-[43vh]">
            <div class="flex flex-col w-full" id="edit-note-conteiner">
                <input id="edit-note-title" type="text" value="${note.title.replace(/"/g, '&quot;')}" placeholder="Tytuł notatki"
                    class="my-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-lg text-black dark:text-white bg-white dark:bg-dark-surface placeholder-gray-400      dark:placeholder-gray-500 focus:outline-none focus:ring-0 font-jetbrains-mono">
                <textarea id="edit-note-content" rows="10" placeholder="Treść notatki"
                    class="h-[33.5vh] my-1 w-full p-4 border border-gray-300 dark:border-gray-600 rounded resize-none text-sm text-black dark:text-white bg-white dark:bg-dark-surface focus:outline-none         focus:ring-0 overflow-auto font-jetbrains-mono">${note.content}</textarea>
            </div>
            <div id="note-preview"
                class="w-full lg:w-1/2 px-2 p-2 rounded prose dark:prose-invert bg-white dark:bg-dark-surface hitespace-pre-wrap break-words text-left hidden">

            </div>
        </div>
        `;
    }
</script>
<script defer src="/scripts/footer.js"></script> <!-- Footer script -->