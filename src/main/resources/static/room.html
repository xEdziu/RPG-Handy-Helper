<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>PokÃ³j czatu</title>
    <link id="favicon" rel="icon" type="image/svg+xml" href="/img/logo/logo-light.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=League+Spartan:wght@100..900&display=swap');

        .font-league-spartan {
            font-family: 'League Spartan', sans-serif;
        }

        .font-jetbrains-mono {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Dodanie SweetAlert2 -->
    <script src="https://kit.fontawesome.com/0a5e3ca64c.js" crossorigin="anonymous"></script>
    <!-- Dodanie Font Awesome -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> <!-- Dodanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Dodanie Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script> <!-- Dodanie sockjs -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script> <!-- Dodanie STOMP -->
    <script>
        // ===== Ustawienia Tailwind CSS =====
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        dark: {
                            background: "#0F0F0F",
                            backgroundSecondary: "#181818",
                            backgroundTertiary: "#101010",
                            textPrimary: "#E1E1E1",
                            textSecondary: "#AFAFAF",
                            accent: "#12e1b9",
                            border: "#333333",
                            surface: "#1E1E1E",
                            accentDark: "#00B189",
                            success: "#00EE00",
                            error: "#D00000",
                            warning: "#FF9831",
                        },
                        light: {
                            background: "#E1E1E1",
                            backgroundSecondary: "#C1C1C1",
                            backgroundTertiary: "#818181",
                            textPrimary: "#252525",
                            surface: "#F5F5F5",
                            border: "#CCCCCC",
                            textSecondary: "#505050",
                            accent: "#ED1E46",
                            accentDark: "#BD0016",
                            success: "#009688",
                            error: "#b388FF",
                            warning: "#FF6F00",
                        },
                    },
                },
            },
        };
        // ==== Zmienne globalne ====
        var numOfDice = {
            D4: 0,
            D6: 0,
            D8: 0,
            D10: 0,
            D12: 0,
            D20: 0,
            D100: 0
        };
        var userInfo = null;
        var gameId = null;
        var allNotesForGame = null;
        var noteEditorMode = 'preview';
        var gameInfo = {
            id: null,
            name: null,
            system: null,
            description: null,
        }
        const roomId = window.location.pathname.split("/").pop()
        // ===== DOMContentLoaded =====
        document.addEventListener("DOMContentLoaded", () => {
            getUserInfo();
            initThemeToggle();
            applyTheme(getSavedTheme());
            getGameInfo();
            loadAllNotes();
            setTimeout(() => {
                loadNotes();
            }, 1000);
            getListenerSearchInput();
        });
        // ==== Changing the theme ====
        function initThemeToggle() {
            const wrapper = document.getElementById("theme-toggle-wrapper");
            const toggle = document.getElementById("switch-component");
            if (!toggle) return;

            const updateTheme = () => {
                const theme = toggle.checked ? "dark" : "light";
                applyTheme(theme);
            };

            toggle.addEventListener("change", updateTheme);
            wrapper?.addEventListener("click", () => {
                toggle.checked = !toggle.checked;
                updateTheme();
            });
        }
        function applyTheme(theme) {
            document.body.classList.toggle("dark", theme === "dark");
            localStorage.setItem("theme", theme);
            updateFavicon(theme);

            const toggle = document.getElementById("switch-component");
            if (toggle) {
                toggle.checked = (theme === "dark");
            }
        }
        function updateFavicon(theme) {
            const favicon = document.getElementById("favicon");
            if (favicon) {
                favicon.href = `/img/logo/logo-${theme}.svg`;
            }
        }
        function getSavedTheme() {
            return localStorage.getItem("theme") ||
                (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        }
        // ==== CRF Token ====
        function getCsrfToken() {
            const name = "XSRF-TOKEN=";
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name)) {
                    return decodeURIComponent(cookie.substring(name.length));
                }
            }
            return null;
        }
        // ==== Get User Info ====
        function getUserInfo() {
            fetch('/api/v1/authorized/user', {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                userInfo = data;
            }).catch(error => {
                console.error('Error fetching user info:', error);
            });
        }
        // ==== Get Game ID from URL ====
        function getGameInfo() {
            var roomId = window.location.pathname.split("/").pop();
            fetch(`/api/v1/authorized/gameRoom/gameIdForRoomId/${roomId}`, {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(response => {
                if (!response.ok) throw new Error('Failed to fetch gameId');
                return response.json();
            }).then(data1 => {
                gameInfo.id = data1.gameId;

                return fetch(`/api/v1/authorized/game/userGames`, {
                    method: 'GET',
                    headers: {
                        'X-XSRF-TOKEN': getCsrfToken()
                    }
                });
            }).then(response => {
                if (!response.ok) throw new Error('Failed to fetch userGames');
                return response.json();
            }).then(data2 => {
                var game = data2.userGames.find(game => game.id == gameInfo.id);
                if (game) {
                    gameInfo.name = game.name;
                    gameInfo.description = game.description;
                    gameInfo.system = game.rpgSystemId;
                }

                return fetch(`/api/v1/authorized/rpgSystems/${gameInfo.system}`, {
                    method: 'GET',
                    headers: {
                        'X-XSRF-TOKEN': getCsrfToken()
                    }
                });
            }).then(response => {
                if (!response.ok) throw new Error('Failed to fetch rpgSystem');
                return response.json();
            }).then(data3 => {
                gameInfo.system = data3.rpgSystem.name;
            }).catch(error => {
                console.error('Error fetching game info:', error);
            });
        }
        // ==== Note Functions ====
        function loadAllNotes() {
            fetch('/api/v1/authorized/gameNotes', {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                if (data.error !== 200) {
                    console.error('API Error:', data.error);
                }
                noteContent = data.gameNotes;
            }).catch(error => {
                console.error('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ notatek:', error);
            });
        }
        function loadNotes() {
            fetch(`/api/v1/authorized/gameNotes/game/${gameInfo.id}`, {
                method: 'GET',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                allNotesForGame = data.gameNotes;
                noteContent = [...allNotesForGame];
                const notesContent = document.getElementById("notes-content");
                notesContent.innerHTML = "";
                if (allNotesForGame.length == 0) {
                    notesContent.innerHTML = generateInfoHTML(
                        `Nie masz jeszcze Å¼adnych notatek!`,
                        `Na szczÄ™Å›nie masz juÅ¼ odblokowanÄ… umiejÄ™tnoÅ›Ä‡ pisania`,
                        `UtwÃ³rz swojÄ… pierwszÄ… notatkÄ™ juÅ¼ teraz.`
                    );
                } else {
                    allNotesForGame.forEach(note => {
                        notesContent.innerHTML += generatePieceOfNoteHTML(note);
                    });
                }
            }).catch(error => {
                console.error('Error fetching notes:', error);
            });
        }
        function displayNote(idNote) {
            noteEditorMode = 'preview';
            const note = noteContent.find(note => note.id == idNote);
            const noteEditor = document.getElementById('note-editor');
            noteEditor.innerHTML = '';
            noteEditor.innerHTML = generateNoteHTML(note);
            actualNote = note;
            showNoteEditor();
        }
        function createNote() {
            noteEditorMode = 'create';
            const noteEditor = document.getElementById('note-editor');
            noteEditor.innerHTML = '';
            noteEditor.innerHTML = generateNewNoteHTML();
            showNoteEditor();
        }
        function deleteNote(idNote) {
            Swal.fire({
                title: 'Czy na pewno chcesz usunÄ…Ä‡ tÄ™ notatkÄ™?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Tak, usuÅ„!',
                cancelButtonText: 'Anuluj'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/v1/authorized/gameNotes/delete/${idNote}`, {
                        method: 'DELETE',
                        headers: {
                            'X-XSRF-TOKEN': getCsrfToken()
                        }
                    }).then(
                        response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        }
                    ).then(data => {
                        if (data.error != "200") {
                            console.error('API Error:', data.error);
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: 'Notatka zostaÅ‚a usuniÄ™ta!',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            noteContent = noteContent.filter(note => note.id !== idNote);
                            loadNotes();
                            hideNoteEditor();
                        }
                    }).catch(error => {
                        console.error('Nie udaÅ‚o siÄ™ usunÄ…Ä‡ notatki:', error);
                    });
                }
            });
        }
        function saveNote(idNote) {
            getListenerParser();
            const noteTitle = document.getElementById('note-title').value.trim();
            const noteText = document.getElementById('note-content').value.trim();
            const gameId = gameInfo.id;
            noteContent.forEach(note => {
                if (note.title == noteTitle && note.id != idNote) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'TytuÅ‚ juÅ¼ istnieje!',
                        text: `ZmieÅ„ tytuÅ‚ notatki, aby zapisaÄ‡ obecnÄ….`,
                    });
                    return;
                }
            })
            var data = [
                { obiekt: noteTitle, name: 'Brak tytuÅ‚u!' },
                { obiekt: noteText, name: 'Brak treÅ›ci!' }
            ]
            data.forEach(element => {
                if (element.obiekt == null || element.obiekt == undefined || element.obiekt == '') {
                    Swal.fire({
                        icon: 'warning',
                        title: `${element.name}`,
                        text: `UzupeÅ‚nij wszystkie pola. `,
                    });
                    return;
                }
            });
            if (!gameId || gameId == null || gameId == undefined || gameId == '') {
                return;
            }
            const note = {
                title: noteTitle,
                content: noteText,
                gameId: gameId,
                userId: userInfo.id
            };
            fetch('/api/v1/authorized/gameNotes/add', {
                method: 'POST',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(note)
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                if (data.error != "200") {
                    console.error('API Error:', data.error);
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Notatka zostaÅ‚a zapisana!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    loadNotes();
                    hideNoteEditor();
                    document.getElementById('search-input').disabled = false;
                }
            }).catch(error => {
                console.error('Nie udaÅ‚o siÄ™ zapisaÄ‡ notatki:', error);
            });
        }
        function editNote(idNote) {
            noteEditorMode = 'edit';
            const note = noteContent.find(note => note.id == idNote);
            const noteEditor = document.getElementById('note-editor');
            noteEditor.innerHTML = '';
            noteEditor.innerHTML = generateEditNoteHTML(note);
            showNoteEditor();
        }
        function showPreviewNote(mode = '') {
            getListenerParser();
            const preview = document.getElementById('note-preview');
            let noteTitleBox, noteContentBox, noteContainer, button;
            if (mode === "create") {
                noteTitleBox = document.getElementById('note-title');
                noteContentBox = document.getElementById('note-content');
                noteContainer = document.getElementById('new-note-content');
                button = document.getElementById('create-preview-note');
            } else {
                noteTitleBox = document.getElementById('edit-note-title');
                noteContentBox = document.getElementById('edit-note-content');
                noteContainer = document.getElementById('edit-note-container');
                button = document.getElementById('edit-preview-note');
            }
            if (!noteTitleBox || !noteContentBox || !preview) {
                console.warn('Brakuje elementÃ³w do dynamicznego podglÄ…du.');
                return;
            }
            let title = noteTitleBox.value.trim() || "Notatki bez tytuÅ‚u?";
            let content = noteContentBox.value.trim() || "<p><em>*PodglÄ…d pusty...*</em></p>";
            preview.innerHTML = `
                <h2 class="text-2xl font-bold font-jetbrains-mono text-light-textPrimary dark:text-dark-textPrimary text-left py-1 pb-[1.3em]">${title}</h2>
                <div class="h-[32vh] overflow-auto font-jetbrains-mono text-left text-sm text-light-textSecondary dark:text-dark-textSecondary whitespace-pre-wrap break-words">
                    ${parseMarkdown(content, true)}
                </div>
            `;
            const show = preview.classList.contains('hidden');
            if (button) {
                if (show) {
                    button.innerText = "Zamknij podglÄ…d";
                } else {
                    button.innerText = "PodglÄ…d";
                }
            }
            if (_isMobile) {
                noteTitleBox.classList.toggle('hidden', show);
                noteContentBox.classList.toggle('hidden', show);
                preview.classList.toggle('hidden', !show);
            } else {
                preview.classList.toggle('hidden', !show);
                preview.classList.toggle('block', show);
                preview.classList.toggle('w-1/2', show);
                noteContainer.classList.toggle('w-1/2', show);
            }
        }
        function saveEditedNote(noteId) {
            disableListenerParser();
            const noteTitle = document.getElementById('edit-note-title').value.trim();
            const newNoteContent = document.getElementById('edit-note-content').value.trim();
            const oldNote = noteContent.find(note => note.id == noteId);
            if (noteTitle === '' || newNoteContent === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Nie moÅ¼na zapisaÄ‡ notatki!',
                    text: 'TytuÅ‚ i treÅ›Ä‡ notatki nie mogÄ… byÄ‡ puste. UzupeÅ‚nij brakujÄ…ce pola przed zapisaniem.',
                });
                return;
            }
            if (noteContent.some(note => note.title === noteTitle && note.id !== noteId)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'TytuÅ‚ juÅ¼ istnieje!',
                    text: `ZmieÅ„ tytuÅ‚ notatki, aby zapisaÄ‡ obecnÄ….`,
                });
                return;
            }
            const note = {
                gameId: gameInfo.id,
                userId: userInfo.id,
                title: noteTitle,
                content: newNoteContent,
            };
            fetch(`/api/v1/authorized/gameNotes/update/${noteId}`, {
                method: 'PUT',
                headers: {
                    'X-XSRF-TOKEN': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(note)
            }).then(
                response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                }
            ).then(data => {
                if (data.error != "200") {
                    console.error('API Error:', data.error);
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Notatka zostaÅ‚a zaktualizowana!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    noteContent = noteContent.map(note => {
                        if (note.id == noteId) {
                            return {
                                ...note,
                                title: noteTitle,
                                content: newNoteContent,
                                updatedAt: new Date().toISOString()
                            };
                        }
                        return note;
                    });
                    loadNotes();
                    hideNoteEditor();
                    document.getElementById('search-input').disabled = false;
                }
            }).catch(error => {
                console.error('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ notatki:', error);
            });
        }
        // ==== Function Editor Display ====
        function showNoteEditor() {
            const backdrop = document.getElementById('note-editor-backdrop');
            const editor = document.getElementById('note-editor');
            backdrop.classList.remove('pointer-events-none', 'opacity-0');
            backdrop.classList.add('opacity-100');
            editor.classList.remove('scale-95', 'opacity-0');
            editor.classList.add('scale-100', 'opacity-100');
        }
        function hideNoteEditor() {
            const backdrop = document.getElementById('note-editor-backdrop');
            const editor = document.getElementById('note-editor');
            backdrop.classList.add('opacity-0', 'pointer-events-none');
            backdrop.classList.remove('opacity-100');
            editor.classList.add('scale-95', 'opacity-0');
            editor.classList.remove('scale-100', 'opacity-100');
        }
        function getListenerSearchInput() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    console.log("Wyszukiwanie notatek...");
                    const searchTerm = this.value.toLowerCase();
                    const notesContent = document.getElementById("notes-content");
                    notesContent.innerHTML = "";
                    if (searchTerm === "") {
                        allNotesForGame.forEach(note => {
                            notesContent.innerHTML += generatePieceOfNoteHTML(note);
                        });
                        return;
                    }
                    const filteredNotes = allNotesForGame.filter(note =>
                        note.title.toLowerCase().includes(searchTerm) ||
                        note.content.toLowerCase().includes(searchTerm)
                    );
                    if (filteredNotes.length === 0) {
                        notesContent.innerHTML = generateInfoHTML(
                            `Nie znaleziono notatek!`,
                            `SprÃ³buj zmieniÄ‡ sÅ‚owo kluczowe.`,
                            `Upewnij siÄ™, Å¼e wpisujesz poprawne sÅ‚owa kluczowe.`
                        );
                    } else {
                        filteredNotes.forEach(note => {
                            notesContent.innerHTML += generatePieceOfNoteHTML(note);
                        });
                    }
                });
            }
        }
    </script>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <nav
        class="flex justify-around w-full p-6 bg-light-surface dark:bg-dark-surface border-b border-light-border dark:border-dark-border">
        <a href="/home">
            <div class="flex items-center">
                <img id="logo-light" src="/img/logo/logo-light.svg" alt="RPG Manager" class="h-10 w-10 dark:hidden">
                <img id="logo-dark" src="/img/logo/logo-dark.svg" alt="RPG Manager" class="h-10 w-10 hidden dark:block">
                <h1
                    class="text-xl font-semibold ml-3 text-light-textPrimary dark:text-dark-textPrimary font-jetbrains-mono">
                    RPG Handy Helper
                </h1>
            </div>
        </a>
        <div id="theme-toggle-wrapper" class="flex items-center justify-center">
            <i class="fa-solid fa-sun p-2 text-light-accent dark:text-dark-accent"></i>
            <div class="relative inline-block w-12 h-6">
                <input id="switch-component" type="checkbox" class="peer hidden m-1" />
                <label for="switch-component" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full
                       bg-light-accent dark:bg-dark-accent
                       shadow-md transition-all duration-300 
                       peer-checked:translate-x-[0.75rem] 
                       peer-checked:dark:bg-dark-accent peer-checked:bg-light-accent
                       cursor-pointer hover:shadow-lg">
                </label>
                <div class="w-12 h-6 rounded-full transition-all duration-300 cursor-pointer
                        bg-light-backgroundSecondary dark:bg-dark-backgroundTertiary">
                </div>
            </div>
            <i class="fa-solid fa-moon p-2 text-light-accent dark:text-dark-accent"></i>
        </div>
    </nav>
    <main
        class="min-h-[86.75vh] flex-grow flex flex-col items-center justify-center bg-light-background dark:bg-dark-background w-full">
        <div id="content-box" class="flex flex-col 2xl:flex-row items-center justify-center w-[100%] min-h-[80vh] p-4">
            <section id="character-card"
                class="flex flex-col items-start justify-start w-[100%] sm:w-[80%] md:w-[75%] xl:w-[45vw] bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg w-full max-w-xl p-4 px-8 h-auto 2xl:h-[85vh] m-3">
                <div id="character-card-info"
                    class="flex flex-row items-center justify-between w-full my-4 cursor-pointer"
                    onclick="toggleCard('character-card-contrent', 'character-card-buttons', 'character-card-link')">
                    <h1 class="font-jetbrains-mono text-3xl text-light-textPrimary dark:text-dark-textPrimary">
                        Karta Postaci
                    </h1>
                    <div class="flex" class="h-10">
                        <a href="#" id="character-card-link" class="invisible 2xl:block 2xl:visible" target="_blank">
                            <i class="fa-solid fa-arrow-up-right-from-square text-3xl text-light-textPrimary dark:text-dark-textPrimary mr-3"
                                aria-hidden="true"></i>
                        </a>
                        <div id="character-card-buttons" class="2xl:hidden">
                            <img src="/img/assets/expand_button_light_version.svg"
                                class="toggle-icon h-10 w-10 transition-transform duration-5000 ease-in-out dark:hidden">
                            <img src="/img/assets/expand_button_dark_version.svg"
                                class="toggle-icon h-10 w-10 transition-transform duration-5000 ease-in-out hidden dark:block">
                        </div>
                    </div>
                </div>

                <div id="character-card-contrent" class="hidden 2xl:block">
                    <h1 class="font-jetbrains-mono text-3xl">#BÄ™dzie</h1>
                </div>
            </section>

            <section id="chat-container"
                class="flex flex-col items-start justify-start w-[100%] sm:w-[80%] md:w-[75%] xl:w-[45vw] bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg w-full max-w-xl p-4 px-2 h-auto 2xl:h-[85vh] m-3">
                <div class="flex flex-col gap-2 w-full ">
                    <div id="chat"
                        class="flex flex-col gap-2 bg-white dark:bg-dark-background border border-gray-300 dark:border-dark-border rounded-lg p-4 h-[50vh] 2xl:h-[72vh] overflow-y-auto mb-4 text-sm ">
                        <!-- WiadomoÅ›ci bÄ™dÄ… dodawane tutaj -->
                    </div>
                    <form id="message-form" class="flex gap-2">
                        <input type="text" id="message-input" placeholder="WyÅ›lij wiadomoÅ›Ä‡..." autocomplete="off"
                            required
                            class="flex-1 px-3 py-2 rounded-full border border-gray-400 text-sm dark:bg-dark-surface dark:text-white font-jetbrains-mono placeholder:text-sm" />
                        <button type="submit"
                            class="px-5 py-2 font-bold rounded-full bg-light-accent dark:bg-dark-accent text-dark-textPrimary dark:text-dark-textPrimary transition-colors text-sm">
                            WyÅ›lij
                        </button>
                    </form>
                </div>
            </section>
            <section id="personal-info"
                class="flex flex-col-reverse 2xl:flex-col items-start justify-start w-[100%] sm:w-[80%] md:w-[75%] xl:w-[45vw] w-full max-w-xl h-auto 2xl:h-[85vh]">
                <article id="notes-card"
                    class="flex flex-col items-start justify-start grow w-[100%] bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg w-full max-w-xl h-[79%] mb-3 p-4">
                    <div id="notes-card-info"
                        class="flex flex-row items-center justify-between w-full my-4 cursor-pointer 2xl:hidden"
                        onclick="toggleCard('notes-card-contrent', 'notes-card-buttons', 'notes-card-link')">
                        <h1 class="font-jetbrains-mono text-3xl text-light-textPrimary dark:text-dark-textPrimary">
                            Notatki
                        </h1>
                        <div class="flex" class="h-10">
                            <a href="#" id="notes-card-link" class="invisible 2xl:block 2xl:visible" target="_blank">
                                <i class="fa-solid fa-arrow-up-right-from-square text-3xl text-light-textPrimary dark:text-dark-textPrimary mr-3"
                                    aria-hidden="true"></i>
                            </a>
                            <div id="notes-card-buttons" class="2xl:hidden">
                                <img src="/img/assets/expand_button_light_version.svg"
                                    class="toggle-icon h-10 w-10 transition-transform duration-5000 ease-in-out dark:hidden">
                                <img src="/img/assets/expand_button_dark_version.svg"
                                    class="toggle-icon h-10 w-10 transition-transform duration-5000 ease-in-out hidden dark:block">
                            </div>
                        </div>
                    </div>
                    <a href="/home/notes" id="notes-card-link" class="z-5 relative -right-[94%] top-3" target="_blank">
                        <i class="fa-solid fa-arrow-up-right-from-square text-3xl text-light-textPrimary dark:text-dark-textPrimary mr-3"
                            aria-hidden="true"></i>
                    </a>

                    <div id="notes-card-contrent"
                        class="hidden 2xl:block w-full flex flex-col items-center justify-start 2xl:mt-[3rem]">
                        <div id="notes-info" class="flex flex-col items-center justify-center h-[10%] w-full mb-8">
                            <button id="add-note"
                                class="text-2xl sm:text-3xl py-4 px-[1em] mb-4 bg-light-accent dark:bg-dark-accent text-dark-textPrimary dark:text-dark-textPrimary rounded-lg hover:bg-light-accentDark dark:hover:bg-dark-accentDark transition duration-300 whitespace-nowrap font-bold font-jetbrains-mono disabled:dark:bg-dark-accentDark disabled:cursor-not-allowed disabled:bg-light-accentDark disabled:opacity-50"
                                onclick="createNote()">
                                STWÃ“RZ NOWÄ„ NOTATKÄ˜
                            </button>
                            <div class="w-full flex items-center space-x-2 mb-3">
                                <label
                                    class="font-semibold text-light-textPrimary dark:text-dark-textPrimary whitespace-nowrap">
                                    Wyszukaj
                                </label>
                                <div class="w-full">
                                    <input type="text" placeholder="Wpisz sÅ‚owo klucz" id="search-input"
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm text-black dark:text-white bg-white dark:bg-dark-surface placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-0" />
                                </div>
                            </div>
                        </div>
                        <div id="notes-content"
                            class="w-[100%] max-h-[45vh] flex flex-col items-center justify-start p-3 overflow-y-auto">
                            <div class="my-[10vh] w-12 h-12 border-4 border-light-accent dark:border-dark-accent rounded-full animate-ping"
                                role="status" aria-label="Åadowanie"></div>
                        </div>
                    </div>
                </article>
                <article id="dice-container"
                    class="w-full bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg h-[19%] p-6 flex-col justify-center items-center gap-1 mb-3 2xl:mb-0">
                    <div class="controls flex justify-around items-center gap-2 mb-4" id="diceContainer">
                        <!-- Generowane koÅ›ci JS-->
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="relative w-max">
                            <select id="dice-theme"
                                class="font-jetbrains-mono appearance-none bg-light-surface dark:bg-dark-surface text-light-textPrimary dark:text-dark-textPrimary border border-black dark:border-white px-4 py-2 pr-10 rounded-md shadow-sm">
                            </select>
                            <img src="/img/assets/expand_button_light_version.svg"
                                class="pointer-events-none absolute right-3 z-3 mt-[-2rem] dark:hidden block w-6 h-6"
                                alt="Expand Light" />
                            <img src="/img/assets/expand_button_dark_version.svg"
                                class="pointer-events-none absolute right-3 z-3 mt-[-2rem] dark:block hidden w-6 h-6"
                                alt="Expand Dark" />
                        </div>
                        <div class="flex flex-col-reverse 2xl:flex-row items-center gap-2">
                            <button id="rollReset"
                                class="text-base font-bold font-jetbrains-mono bg-light-accent dark:bg-dark-accent text-white px-4 py-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark transition duration-300 whitespace-nowrap">
                                Reset
                            </button>
                            <button id="rollCustom"
                                class="text-base font-bold font-jetbrains-mono bg-light-accent dark:bg-dark-accent text-white px-4 py-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark transition duration-300 whitespace-nowrap">
                                RzuÄ‡
                            </button>
                        </div>
                    </div>
                    <div id="dice-container-trow" class="fixed top-0 left-0 w-screen h-screen pointer-events-none z-50">
                    </div>
                </article>
            </section>
        </div>
        <!-- Edytor notatki -->
        <div id="note-editor-backdrop"
            class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none bg-black/30 dark:bg-black/50 transition-opacity duration-300">
            <div id="note-editor"
                class="w-[90vw] sm:w-[95vw] md:w-[70vw] lg:w-[50vw] bg-white dark:bg-dark-surface text-black dark:text-white p-6 px-10 rounded-lg shadow-xl overflow-auto flex-col justify-between transition-all duration-300 ease-in-out scale-95 opacity-0">
            </div>
        </div>
    </main>
    <footer
        class="w-full text-center p-4 bg-light-surface dark:bg-dark-surface font-jetbrains-mono text-light-text dark:text-dark-text border-t border-light-border dark:border-dark-border">
        <h3 class="text-light-textPrimary dark:text-dark-textPrimary">Od Graczy dla Graczy Â© 2025 RPG Handy Helper</h3>
        <a href="https://github.com/xEdziu/RPG-Handy-Helper" target="_blank"
            class="text-light-accent dark:text-dark-accent">
            <i class="fa-brands fa-github"></i>
        </a>
    </footer>
</body>

</html>
<script type="module">
    import DiceBox from "https://cdn.jsdelivr.net/npm/@3d-dice/dice-box@1.1.4/dist/dice-box.es.min.js";
    let username = null;
    let stompClient = null;
    var usersMap = {};
    const userColors = [
        "text-red-500",
        "text-blue-500",
        "text-green-500",
        "text-yellow-500",
        "text-purple-500",
        "text-pink-500",
        "text-indigo-500",
        "text-emerald-500",
    ];
    fetch("/api/v1/authorized/user")
        .then(res => res.json())
        .then(data => {
            username = data.username;
            getUserColorAndPhoto(username);
            initWebSocket();
        });

    function initWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, () => {
            stompClient.subscribe(`/topic/chat/${roomId}`, msg => {
                const { from, content } = JSON.parse(msg.body);
                appendMessage(from, content, false);
            });
            stompClient.subscribe(`/user/topic/chat/${roomId}`, msg => {
                // tu zostawiamy prefix â€žDo â€¦â€ w from, Å¼eby widzieÄ‡ â€žDo zuberâ€
                const { from, content } = JSON.parse(msg.body);
                appendMessage(from, content, true);
            });
            stompClient.subscribe(`/topic/dice/${roomId}`, msg => {
                const { from, content } = JSON.parse(msg.body);
                if (from !== username) {
                    const [notation, theme] = content.split("|");
                    rollDice(notation, theme, from);
                }
            });
            stompClient.send(`/app/join/${roomId}`, {}, {});
        });
    }
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }
    function appendMessage(from, content, pv = false) {
        const chat = document.getElementById("chat");
        const wrapper = document.createElement("div");
        wrapper.innerHTML = messageHTML(from, content, pv);
        chat.appendChild(wrapper);
        chat.scrollTop = chat.scrollHeight;
    }
    document.getElementById("message-form").addEventListener("submit", e => {
        e.preventDefault();
        const input = document.getElementById("message-input");
        const content = input.value.trim();
        if (content && stompClient?.connected) {
            stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({ from: username, content }));
            input.value = "";
        }
    });
    // ==== DICE OPERATIONS ====
    const themes = [
        { id: "default", label: "DomyÅ›lny" },
        { id: "gemstoneMarble", label: "Gemstone Rainbow Marble" },
        { id: "blueGreenMetal", label: "Blue Green Metal" }
    ];
    const themeSelect = document.getElementById("dice-theme");
    const savedTheme = localStorage.getItem("selectedDiceTheme") || "default";
    themes.forEach(({ id, label }) => {
        const opt = new Option(label, id, false, id === savedTheme);
        themeSelect.appendChild(opt);
    });
    themeSelect.addEventListener("change", () => {
        localStorage.setItem("selectedDiceTheme", themeSelect.value);
    });
    const diceBox = new DiceBox("#dice-container-trow", {
        assetPath: "/assets/",
        origin: location.origin,
        scale: 5,
        gravity: 3,
        friction: 0.5,
        strength: 10,
        spinForce: 6,
        throwForce: 6,
        mass: 3
    });
    const canvas = document.querySelector("#dice-container-trow canvas");
    const scaleFactor = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * scaleFactor;
    canvas.height = window.innerHeight * scaleFactor;
    canvas.style.width = "100vw";
    canvas.style.height = "100vh";
    await diceBox.init();
    await diceBox.loadTheme("default");
    let rolling = false;
    let rollPool = [];
    document.getElementById("rollReset").addEventListener("click", () => {
        if (rolling) return;
        rolling = true;
        document.querySelectorAll('button[id^="roll"]').forEach(btn => btn.disabled = true);
        diceBox.clear();
        rollPool = [];
        rolling = false;
        Object.keys(numOfDice).forEach(k => numOfDice[k] = 0);
        var diceCont = document.getElementsByClassName('diceCount');
        for (let i = 0; i < diceCont.length; i++) {
            diceCont[i].innerText = "";
        }
    });
    document.getElementById("rollCustom").addEventListener("click", async () => {
        const segments = Object.entries(numOfDice)
            .filter(([type, qty]) => qty > 0)
            .map(([type, qty]) => ({ qty, sides: parseInt(type.slice(1)) }));

        if (segments.length === 0) {
            return Swal.fire({ icon: 'warning', title: 'Brak koÅ›ci', text: 'Wybierz co najmniej jednÄ… koÅ›Ä‡.' });
        }
        if (rolling) return;
        rolling = true;
        document.querySelectorAll('button[id^="roll"]').forEach(btn => btn.disabled = true);
        let total = 0, nat = [];
        const theme = themeSelect.value;
        if (!diceBox.themesLoadedData[theme]) await diceBox.loadTheme(theme);
        for (let { qty, sides } of segments) {
            const res = await diceBox.roll(`${qty}d${sides}`, {
                theme,
                throwStartPosition: {
                    x: Math.random() * 2 - 1, // od -1 do 1
                    y: Math.random() * 2 - 1, // od -1 do 1
                    z: 0
                }
            });
            total += res.reduce((sum, die) => sum + die.value, 0);
            res.forEach(d => {
                nat.push(d.sides === 20 && (d.value === 1 || d.value === 20)
                    ? (d.value === 20 ? 'ðŸŽ¯ NAT20' : 'ðŸ’€ NAT1')
                    : `d${d.sides}: ${d.value}`);
            });
            await new Promise(r => setTimeout(r, 1500));
            diceBox.clear();
        }
        stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({
            from: "ðŸŽ² Rzut koÅ›ciÄ…",
            content: `${username} wyrzuciÅ‚ ${total} (${nat.join(", ")})`,
            privateMessage: false
        }));
        Object.keys(numOfDice).forEach(k => numOfDice[k] = 0);
        rolling = false;
        var visibleDiceCount = document.getElementsByClassName('diceCount');
        for (let i = 0; i < visibleDiceCount.length; i++) {
            visibleDiceCount[i].innerText = "";
        }
        Object.keys(numOfDice).forEach(k => numOfDice[k] = 0);
        document.querySelectorAll('button[id^="roll"]').forEach(btn => btn.disabled = false);
        rolling = false;
    });

    function getUserColorAndPhoto(username) {
        if (!username || username === "System") {
            return {
                color: "text-gray-500",
                photo: "/img/profilePics/cyberpunkDefaultProfilePic.png"
            };
        }
        if (!usersMap[username]) {
            const index = Object.keys(usersMap).length % userColors.length;
            const color = userColors[index];
            usersMap[username] = {
                color,
                photo: "/img/profilePics/cyberpunkDefaultProfilePic.png"
            };

            // Najpierw pobierz JSON ze Å›cieÅ¼kÄ…
            fetch(`/api/v1/authorized/user/photo/username/${username}`)
                .then(res => {
                    if (!res.ok) throw new Error("Brak Å›cieÅ¼ki do zdjÄ™cia");
                    return res.json();
                })
                .then(data => {
                    // WyciÄ…gnij nazwÄ™ pliku ze Å›cieÅ¼ki, np. "/img/profilePics/abc.png" -> "abc.png"
                    const path = data.userPhotoPath;
                    const filename = path.split('/').pop();

                    // Pobierz plik jako blob
                    return fetch(`/api/v1/authorized/user/photo/${filename}`);
                })
                .then(res => {
                    if (!res.ok) throw new Error("Brak pliku zdjÄ™cia");
                    return res.blob();
                })
                .then(blob => {
                    const objectUrl = URL.createObjectURL(blob);
                    usersMap[username].photo = objectUrl;
                    document.querySelectorAll(`img[data-username="${username}"]`).forEach(img => {
                        img.src = objectUrl;
                    });
                })
                .catch(err => {
                    console.error(`Avatar ${username} error:`, err);
                });
        }
        return usersMap[username];
    }
    function messageHTML(from, content, pv = false) {
        const cleanFrom = from.replace(/^Do\s+/, "");
        const isSystem = cleanFrom === "System" || cleanFrom === "ðŸ§Š System";
        const isDiceRoll = cleanFrom.startsWith("ðŸŽ² Rzut koÅ›ciÄ…");
        // 1. WiadomoÅ›Ä‡ systemowa
        if (isSystem) {
            return `
            <div class="w-full text-center italic text-gray-500 text-sm py-2">
                ${escapeHtml(content)}
            </div>
        `;
        }
        // 2. Rzut koÅ›ciÄ…
        if (isDiceRoll) {
            var userName = content.split(" ")[0];
            var userColor = getUserColorAndPhoto(userName).color;
            content = content.replace(userName, `<span class="${userColor} font-semibold">${escapeHtml(userName)}</span>`);
            return `
            <div class="flex items-start bg-[#f5f6f8] dark:bg-gray-700 p-3 border-2 border-light-accentDark dark:border-dark-accentDark rounded-lg mb-2">
                <div class="flex-shrink-0 w-12 h-12 mr-3">
                    <img id="logo-light" src="/img/assets/chat-dice-icon-light-version.svg" alt="" class="h-12 w-12 dark:hidden">
                    <img id="logo-dark" src="/img/assets/chat-dice-icon-dark-version.svg" alt="" class="h-12 w-12 hidden dark:block">
                </div>
                <div class="flex flex-col flex-1">
                    <span class="font-bold">
                        <span class="text-xs font-semibold mr-1 text-black dark:text-white">ðŸŽ² KoÅ›ci PowiedziaÅ‚y: </span>
                    </span>
                    <p class="text-black dark:text-white break-words mt-1">
                        ${content}
                    </p>
                </div>
            </div>
            `;
        }
        // 3. Publiczne i prywatne wiadomoÅ›ci (Å¼Ã³Å‚ty border dla prywatnych)
        const userData = getUserColorAndPhoto(cleanFrom);
        const pvClasses = pv
            ? "bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-400 dark:border-yellow-600"
            : "bg-[#f5f6f8] dark:bg-gray-700";

        return `
        <div class="flex items-start ${pvClasses} p-3 rounded-lg mb-2">
            <div class="flex-shrink-0 w-12 h-12 mr-3">
                <img src="${userData.photo}" data-username="${cleanFrom}" alt="${cleanFrom} Avatar" class="w-12 h-12 rounded-full"/>
            </div>
            <div class="flex flex-col flex-1">
                <span class="font-bold ${userData.color}">
                    ${pv ? `<span class="text-xs font-semibold mr-1">ðŸ”’</span>${escapeHtml(from)}` : escapeHtml(cleanFrom)}
                </span>
                <p class="text-black dark:text-white break-words mt-1">
                    ${escapeHtml(content)}
                </p>
            </div>
        </div>
        `;
    }

    // ==== Load Dice Box ====
    const dicesBox = document.getElementById("diceContainer");
    var diceTypes = ["D4", "D6", "D8", "D10", "D12", "D20", "D100"];
    diceTypes.forEach(type => {
        var diceBox = document.createElement("div");
        diceBox.className = "relative flex flex-col items-center justify-center w-10 h-10 group";
        diceBox.innerHTML = `
            <div id="dicePopup${type}" class="dicePopup hidden absolute -top-18 flex flex-col items-center justify-center gap-1 z-3 bg-light-surface dark:bg-dark-surface p-4 rounded-t-full shadow-[0px_-35px_50px_0px_rgba(0,_0,_0,_0.2)] dark:shadow-[0px_-35px_50px_0px_rgba(255,_255,_255,_0.2)] transition-all duration-300 ease-in-out opacity-0">
                <button onclick="addDice('${type.toLowerCase()}')"
                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                    +
                </button>
                <button onclick="removeDice('${type.toLowerCase()}')"
                    class="h-6 w-6 rounded-full bg-light-accent dark:bg-dark-accent text-white text-sm font-bold flex items-center justify-center shadow-md hover:scale-105 transition">
                    âˆ’
                </button>
            </div>
            <div class="flex items-center justify-center w-10 h-10" onclick="showPopup('${type}')">
                <img src="/img/assets/dice-icon-dark-version.svg" class="z-5 w-10 h-10 dark:block hidden" alt="Dice Icon">
                <img src="/img/assets/dice-icon-light-version.svg" class="z-5 w-10 h-10 dark:hidden block" alt="Dice Icon">
                <p class="z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-lg pointer-events-none">
                    ${type.replace("D", "")}
                </p>
                <p id="diceCount${type}" class="diceCount hidden z-5 absolute inset-0 flex items-center justify-center text-light-textPrimary dark:text-dark-textPrimary font-bold text-base pointer-events-none -ml-[3.75rem]">
                    0
                </p>
            </div>
        `;
        dicesBox.appendChild(diceBox);
    });
    // ==== Dice Popup ====
    function showPopup(diceType) {
        setTimeout(() => {
            const dicePopups = document.querySelectorAll('.dicePopup');
            const popupToShow = document.getElementById(`dicePopup${diceType}`);

            dicePopups.forEach(popup => {
                if (popup !== popupToShow) {
                    popup.classList.add('hidden', 'opacity-0');
                    popup.classList.remove('opacity-100');
                }
            });

            if (popupToShow) {
                popupToShow.classList.remove('hidden', 'opacity-0');
                popupToShow.classList.add('opacity-100');
            }
        }, 0);
    }
    window.showPopup = showPopup;
    // ==== Dice Functions ====
    function addDice(type) {
        if (!type || !(type.toUpperCase() in numOfDice)) return;
        if (numOfDice[type.toUpperCase()] >= 20) {
            Swal.fire({
                icon: 'warning',
                title: 'Maksymalna liczba koÅ›ci osiÄ…gniÄ™ta',
                text: 'MoÅ¼esz mieÄ‡ maksymalnie 20 koÅ›ci tego typu.'
            });
            return;
        }
        numOfDice[type.toUpperCase()]++;
        updateDiceCount(type);
    }
    window.addDice = addDice;
    function removeDice(type) {
        if (!type || !(type.toUpperCase() in numOfDice)) return;
        const upperType = type.toUpperCase();
        if (numOfDice[upperType] > 0) {
            numOfDice[upperType]--;
            updateDiceCount(type);
        }
    }
    window.removeDice = removeDice;
    function updateDiceCount(type) {
        const upperType = type.toUpperCase();
        const element = document.getElementById(`diceCount${upperType}`);
        if (element) {
            if (numOfDice[upperType] == 0) {
                element.classList.add('hidden');
            } else {
                element.classList.remove('hidden');
            }
            element.innerHTML = `${numOfDice[upperType]}:`;
        }
    }
    window.updateDiceCount = updateDiceCount;

    function sendDiceRoll(rollText) {
        if (!stompClient || !stompClient.connected) return;
        stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify({
            from: "ðŸŽ² Rzut koÅ›ciÄ…",
            content: rollText,
            privateMessage: false
        }));
    }
</script>
<script>
    // ==== Listener for Window Size ====
    var _isMobile = false;
    window.addEventListener('resize', function () {
        const windowWidth = window.innerWidth
        if (windowWidth < 1024) {
            _isMobile = true;
        } else {
            _isMobile = false;
        }
    });
    window.addEventListener('load', function () {
        const windowWidth = window.innerWidth
        if (windowWidth < 1024) {
            _isMobile = true;
        } else {
            _isMobile = false;
        }
    });
    // ==== Function to Parse Markdown in Real Time ====
    let _markdownParserListeners = [];
    function getListenerParser() {
        const titleInput = document.getElementById('edit-note-title') || document.getElementById('note-title');
        const contentInput = document.getElementById('edit-note-content') || document.getElementById('note-content');
        const preview = document.getElementById('note-preview');
        if (!titleInput || !contentInput || !preview) {
            console.warn('Brakuje elementÃ³w do dynamicznego podglÄ…du.');
            return;
        }
        function updatePreviewLive() {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const parsed = parseMarkdown(content || "", true);
            preview.innerHTML = `
            <h2 class="text-2xl font-bold font-jetbrains-mono text-light-textPrimary dark:text-dark-textPrimary text-left py-1 pb-[1.3em]">${title || "Notatki bez tytuÅ‚u?"}</h2>
            <div class="h-[32vh] overflow-auto font-jetbrains-mono text-left text-sm text-light-textSecondary dark:text-dark-textSecondary whitespace-pre-wrap break-words">
                ${parsed.length > 0 ? parsed : "<p><em>*PodglÄ…d pusty...*</em></p>"}
            </div>
        `;
        }
        titleInput.addEventListener('input', updatePreviewLive);
        contentInput.addEventListener('input', updatePreviewLive);
        _markdownParserListeners = [
            { el: titleInput, fn: updatePreviewLive },
            { el: contentInput, fn: updatePreviewLive }
        ];
        updatePreviewLive();
    }
    function disableListenerParser() {
        if (!_markdownParserListeners || _markdownParserListeners.length === 0) return;
        _markdownParserListeners.forEach(({ el, fn }) => {
            el.removeEventListener('input', fn);
        });
        _markdownParserListeners = [];
    }
    // ==== Parser Markdown ====
    function parseMarkdown(markdownText, ifAllNote = false) {
        var parsedParagraph = marked.parse(markdownText);
        if (ifAllNote) {
            parsedParagraph = parsedParagraph.replace(/<p>/g, '<p class="mt-[-3em]">');
        }
        return parsedParagraph;
    }
    // ==== Truncate Text ====
    function truncateText(text, maxLength = Infinity) {
        return text.length > maxLength
            ? text.slice(0, maxLength) + '...'
            : text;
    }
    // ==== Format Date ====
    function formatDate(dateString) {
        return new Date(dateString).toLocaleString("pl-PL", {
            year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"
        });
    }
    // ==== Listener for Note ====
    document.addEventListener('click', (e) => {
        const dicePopups = document.querySelectorAll('.dicePopup');
        const isPopupButton = e.target.closest('[data-popup-trigger]') !== null;
        let clickedInsideAnyPopup = false;
        dicePopups.forEach(popup => {
            if (popup.contains(e.target)) {
                clickedInsideAnyPopup = true;
            }
        });
        if (!clickedInsideAnyPopup && !isPopupButton) {
            dicePopups.forEach(popup => {
                popup.classList.add('hidden', 'opacity-0');
                popup.classList.remove('opacity-100');
            });
        }

        const backdrop = document.getElementById('note-editor-backdrop');
        const editor = document.getElementById('note-editor');
        if (!editor || !backdrop) return;
        const isEditorVisible = !backdrop.classList.contains('pointer-events-none');
        const clickedBackdrop = isEditorVisible && e.target === backdrop;
        if (!clickedBackdrop) return;
        if (noteEditorMode === 'create') {
            const noteTitle = document.getElementById('note-title').value.trim();
            const noteText = document.getElementById('note-content').value.trim();
            if (noteTitle === '' && noteText === '') {
                noteEditorMode = 'preview';
                hideNoteEditor();
                return;
            }
        }
        if (noteEditorMode === 'edit') {
            const noteTitle = document.getElementById('edit-note-title').value.trim();
            const noteText = document.getElementById('edit-note-content').value.trim();
            if (noteTitle === actualNote.title && noteText === actualNote.content) {
                noteEditorMode = 'preview';
                hideNoteEditor();
                return;
            }
        }
        if (noteEditorMode === 'edit' || noteEditorMode === 'create') {
            Swal.fire({
                title: 'Czy na pewno chcesz wyjÅ›Ä‡?',
                text: 'Niezapisane zmiany zostanÄ… utracone!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Tak, wyjdÅº',
                cancelButtonText: 'Nie, wrÃ³Ä‡'
            }).then((result) => {
                if (result.isConfirmed) {
                    noteEditorMode = 'preview';
                    hideNoteEditor();
                }
            });
        } else {
            noteEditorMode = 'preview';
            hideNoteEditor();
        }
    });
    function toggleCard(cardContent, cardButton, linkButton) {
        if (window.innerWidth >= 1536) {
            return;
        }
        const content = document.getElementById(cardContent);
        const button = document.getElementById(cardButton);
        const link = document.getElementById(linkButton);
        const isHidden = content.classList.contains("hidden");
        content.classList.toggle("hidden");
        link.classList.toggle("invisible");
        const icons = button.querySelectorAll(".toggle-icon");
        icons.forEach(icon => icon.classList.toggle("-rotate-90"));
    }
  
    // ==== Variable for Styling ====
    var noteStyle = "w-[100%] max-w-2xl p-4 border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface rounded-lg cursor-pointer bg-light-surface dark:bg-dark-surface transition duration-300 text-light-textPrimary dark:text-dark-textPrimary hover:bg-light-backgroundTertiary dark:hover:bg-dark-backgroundTertiary mb-4";
    var infoStyle = "w-[100%] max-w-2xl p-4 border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface rounded-lg  cursor-pointer bg-light-surface dark:bg-dark-surface transition duration-300 text-light-textPrimary dark:text-dark-textPrimary font-jetbrains-mono";
    // ==== Function to generate html ====
    function generateInfoHTML(info1, info2, info3) {
        return `
            <div class="${infoStyle}">
                ${info1 ? `<p class="text-light-textPrimary dark:text-dark-textPrimary m-2">${info1}</p>` : ''}
                ${info2 ? `<p class="text-light-textPrimary dark:text-dark-textPrimary m-2">${info2}</p>` : ''}
                ${info3 ? `<p class="text-light-textPrimary dark:text-dark-textPrimary m-2">${info3}</p>` : ''}
            </div>
        `;
    }
    function generatePieceOfNoteHTML(note) {
        return `
        <div class="${noteStyle}" onclick="displayNote(${note.id})">
            <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col text-xl font-semibold mb-1 font-jetbrains-mono gap-x-4">
                    <span class="text-light-accent dark:text-dark-accent"> ${note.gameName}</span>
                    ${note.rpgSystemName}
                </div>
                <small class="hidden sm:block">${formatDate(note.updatedAt)}</small>
            </div>
            <h2 class= "text-2xl font-semibold mb-2 font-jetbrains-mono">${note.title}</h2>
            <p class="ml-8 break-words whitespace-normal overflow-hidden text-ellipsis">${parseMarkdown(truncateText(note.content, 80))}</p>
        </div>
        `;
    }
    function generateNewNoteHTML() {
        return `
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col items-start w-1/2">
                <p id="game-system" class="text-base font-bold text-light-textPrimary dark:text-dark-textPrimary mb-1">${gameInfo.system}</p>
                <p id="game-name" class="text-base font-bold text-light-accent dark:text-dark-accent mb-1">${gameInfo.name}</p>
                <p id="game-description-new-note" class="text-xs font-bold text-light-textPrimary dark:text-dark-textPrimary">${gameInfo.description}</p>
            </div>
            <div class="flex flex-col lg:flex-row gap-2 items-right">
                <button id="save-note"
                    class="text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark"
                    onclick="saveNote()">Zapisz</button>
                <button id="create-preview-note"
                    class="text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark"
                    onclick="showPreviewNote('create')">PodglÄ…d</button>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-4 min-h-[43vh]">
            <div class="flex flex-col w-full" id="new-note-content">
                <input id="note-title" type="text" placeholder="TytuÅ‚ notatki" maxlength="90"
                    class="my-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-lg text-black dark:text-white bg-white dark:bg-dark-surface placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-0 font-jetbrains-mono">
                <textarea id="note-content" rows="10" placeholder="TreÅ›Ä‡ notatki"
                    class="h-[32vh] my-1 w-full p-4 border border-gray-300 dark:border-gray-600 rounded resize-none text-sm text-black dark:text-white bg-white dark:bg-dark-surface focus:outline-none focus:ring-0 overflow-auto font-jetbrains-mono"></textarea>
            </div>
            <div id="note-preview"
                class="w-full lg:w-1/2 px-2 p-2 rounded prose dark:prose-invert bg-white dark:bg-dark-surface hitespace-pre-wrap break-words text-left hidden">

            </div>
        </div>
        `;
    }
    function generateNoteHTML(note) {
        return `
        <div class="flex flex-col sm:flex-row justify-end lg:flex-row gap-2 sm:gap-4 mb-4 sm:mb-0">
            <div class="flex flex-col w-full">
                <p class="text-base font-bold text-light-textPrimary dark:text-dark-textPrimary mb-1">${note.rpgSystemName}</p>
                <p class="text-base font-bold text-light-accent dark:text-dark-accent mb-1">${note.gameName}</p>
                <p id="game-description-new-note" class="text-xs font-bold text-light-textPrimary dark:text-dark-textPrimary">${gameInfo.description}</p>
            </div>
            <div class="flex flex-col items-start justify-start text-xs text-light-textSecondary dark:text-dark-textSecondary whitespace-nowrap">
                <p>Ostatnia modyfikacja: ${formatDate(note.updatedAt)}</p>
                <p>Utworzono: ${formatDate(note.createdAt)}</p>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-4 min-h-[43vh]">
            <div class="flex flex-col w-full">
                <div class="w-full mb-4 flex justify-between items-start gap-2">
                  <h1 class="mt-2 text-2xl font-bold font-jetbrains-mono text-light-textPrimary dark:text-dark-textPrimary leading-tight break-words whitespace-normal w-[70%]">
                    ${note.title}
                  </h1>
                  <div class="flex-shrink-0 flex gap-2 xl:flex-row align-end flex-col md:flex-row">
                    <button onclick="editNote(${note.id})"
                      class="w-fit text-base font-bold bg-light-accent dark:bg-dark-accent text-white px-4 py-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark whitespace-nowrap">
                      Edytuj
                    </button>
                    <button onclick="deleteNote(${note.id})"
                      class="w-[80px] text-base font-bold bg-light-error dark:bg-dark-error text-white px-4 py-2 rounded hover:bg-red-600 whitespace-nowrap">
                      UsuÅ„
                    </button>
                  </div>
                </div>
                <div class="h-[32vh] overflow-auto font-jetbrains-mono text-left text-sm text-light-textSecondary dark:text-dark-textSecondary whitespace-pre-wrap break-words">
                    ${parseMarkdown(note.content, true)}
                </div>
            </div>
        </div>
        `;
    }
    function generateEditNoteHTML(note) {
        return `
        <div class="flex flex-row justify-end lg:flex-row gap-4">
            <div class="flex flex-col w-full">
                <p id="game-system" class="text-base font-bold text-light-textPrimary dark:text-dark-textPrimary mb-1">${note.rpgSystemName}</p>
                <p id="game-name" class="text-base font-bold text-light-accent dark:text-dark-accent mb-1">${note.gameName}</p>
                <p id="game-description-new-note" class="text-xs font-bold text-light-textPrimary dark:text-dark-textPrimary">${gameInfo.description}</p>
            </div>
            <div class="flex gap-2 items-centerv flex-col md:flex-ro">
                <button id="edit-preview-note"
                    class="w-fit text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark whitespace-nowrap"
                    onclick="showPreviewNote('edit')">PodglÄ…d</button>
                <button id="save-note"
                    class="text-base font-bold bg-light-accent dark:bg-dark-accent text-white p-2 rounded hover:bg-light-accentDark dark:hover:bg-dark-accentDark whitespace-nowrap"
                    onclick="saveEditedNote(${note.id})">Zapisz</button>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-4 min-h-[43vh]">
            <div class="flex flex-col w-full" id="edit-note-container">
                <input id="edit-note-title" type="text" value="${note.title.replace(/"/g, '&quot;')}" placeholder="TytuÅ‚ notatki"
                    class="my-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-lg text-black dark:text-white bg-white dark:bg-dark-surface placeholder-gray-400      dark:placeholder-gray-500 focus:outline-none focus:ring-0 font-jetbrains-mono">
                <textarea id="edit-note-content" rows="10" placeholder="TreÅ›Ä‡ notatki"
                    class="h-[33.5vh] my-1 w-full p-4 border border-gray-300 dark:border-gray-600 rounded resize-none text-sm text-black dark:text-white bg-white dark:bg-dark-surface focus:outline-none         focus:ring-0 overflow-auto font-jetbrains-mono">${note.content}</textarea>
            </div>
            <div id="note-preview"
                class="w-full lg:w-1/2 px-2 p-2 rounded prose dark:prose-invert bg-white dark:bg-dark-surface hitespace-pre-wrap break-words text-left hidden">

            </div>
        </div>
        `;
    }
</script>
<script defer src="/scripts/footer.js"></script> <!-- Footer script -->
</body>
</html>
